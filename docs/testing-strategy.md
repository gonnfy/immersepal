# テスト戦略

## 1. 目的

本アプリケーションの品質を確保し、継続的な改善と安定した運用を可能にするため、以下のテスト戦略を定義します。

- バグの早期発見と修正コストの低減
- リグレッション（機能低下）の防止
- 安全なリファクタリングの実現
- 仕様のドキュメント化
- デプロイへの信頼性向上

## 2. 基本方針

- **テストピラミッド/トロフィー:** ユニットテストを土台とし、結合テスト、E2E テストをバランス良く組み合わせます。
- **振る舞いのテスト:** 実装の詳細ではなく、コードが外部から見てどのように振る舞うべきかをテストします。
- **テストの品質:** テストは信頼性が高く（Flaky Test を避ける）、実行速度が速く、保守しやすい状態を保ちます。
- **テストファイルの配置:** テスト対象のソースファイルと同じディレクトリに `*.test.ts` または `*.spec.ts` として配置します (Co-location)。

## 3. テストの種類とツール

- **ユニットテスト (Unit Tests):**
  - **対象:** 個別の関数、フック、UI コンポーネントの表示ロジック、ユーティリティ (`lib`, `hooks`, `components/ui`, `services` のコアロジック)。
  - **ツール:** Vitest (または Jest), React Testing Library (RTL)。
  - **目的:** モジュール単体のロジック検証。依存関係はモック化。高速実行。カバレッジ目標の中心（例: `lib`/`services` で 70-80%）。
- **結合テスト (Integration Tests):**
  - **対象:** 複数モジュール間の連携。API ルートと Service 層の連携、Service 層と DB (テスト用 DB) の連携、UI コンポーネントとカスタムフック/API モックの連携など。
  - **ツール:** Vitest (または Jest), RTL, Supertest (API Routes), Mock Service Worker (MSW), テスト用データベース。
  - **目的:** モジュール間のインターフェースやデータフローの検証。
- **E2E テスト (End-to-End Tests):**
  - **対象:** 主要なユーザーストーリー（例: ログイン〜デッキ作成〜単語登録〜学習完了）。
  - **ツール:** Playwright (推奨) または Cypress。
  - **目的:** システム全体がユーザー視点で正しく動作することの最終確認。コストが高いため、クリティカルパスに限定して実施。

## 4. テスト対象範囲

- **バックエンド (`app/(api)`, `services`, `lib`):** ユニットテストと結合テストを重点的に実施。
- **フロントエンド (`app/(app)`, `components`, `hooks`):** ユニットテスト (RTL) と結合テスト (RTL) を中心に。重要なフローは E2E でカバー。
- **データベース:** Service 層の結合テストで検証。RLS ポリシーは手動確認または専用のテストスクリプトで検証。
- **AI 連携:** 基本的に AI クライアントはモック化してテスト。必要であれば、AI サービス自体との疎通を確認するテストを別途用意（CI では頻繁に実行しない）。

## 5. テスト実行

- **ローカル:** 開発者が開発中に随時実行。
- **CI/CD:** GitHub Actions で Push/PR をトリガーに自動実行。テスト失敗時はマージ/デプロイをブロック。

## 6. テストデータ

テストデータの準備・管理方法を定義する必要があります（例: ファクトリ関数、テストDB のシーディングスクリプト）。

## 7. テストカバレッジ

- CI でカバレッジレポートを生成・確認します。
- カバレッジ率はテストされていない箇所を見つけるための**指標**とし、絶対的な品質基準とはしません。重要なロジックや複雑な分岐を網羅することを目指します。
